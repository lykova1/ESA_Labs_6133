# Практическая работа №4 — Java Message Service (JMS)


## Описание
Веб-приложение **Library Management System**, разработанное с использованием
фреймворка **Spring Boot** и технологий **Spring Data JPA** и **Java Message Service (JMS)**.  
Приложение реализует механизм **журналирования изменений** и **систему уведомлений**
об изменениях в данных с использованием асинхронного обмена сообщениями.

Приложение предоставляет операции добавления, редактирования, удаления и просмотра
данных через веб-интерфейс, а также фиксирует все изменения в базе данных
и отправляет уведомления о выбранных событиях.

В качестве брокера сообщений используется **Apache ActiveMQ**.  
IDE — **IntelliJ IDEA 2025**.

---

## Предметная область
**Библиотека**

- **Author** — автор книги  
- **Book** — книга  
- **ChangeLog** — журнал изменений  

Связи:
- **один автор — много книг (One-To-Many)**  
- **каждая книга принадлежит одному автору (Many-To-One)**  

Сущность `ChangeLog` используется для хранения информации обо всех изменениях,
происходящих с основными сущностями системы.

---

## Архитектура
Приложение реализовано по классической трёхслойной архитектуре:

- **Data layer**  
  JPA-сущности (`Author`, `Book`, `ChangeLog`) и репозитории Spring Data JPA  

- **Business layer**  
  Сервисы (`AuthorService`, `BookService`), содержащие бизнес-логику и отправку JMS-сообщений  

- **Presentation layer**  
  MVC-контроллеры (`AuthorController`, `BookController`) и HTML-шаблоны  

Асинхронная обработка событий реализована с использованием **JMS Queue** и
обработчиков сообщений (`@JmsListener`).

---

## Структура проекта

```text
src
└── main
    ├── java
    │   └── com.example.labs
    │       ├── controller
    │       │   └── view
    │       │       ├── AuthorController.java
    │       │       └── BookController.java
    │       │
    │       ├── dto
    │       │   ├── AuthorFormDto.java
    │       │   ├── BookCreateDto.java
    │       │   ├── BookUpdateDto.java
    │       │   └── ChangeEventDto.java
    │       │
    │       ├── model
    │       │   ├── Author.java
    │       │   ├── Book.java
    │       │   └── ChangeLog.java
    │       │
    │       ├── repository
    │       │   ├── AuthorRepo.java
    │       │   ├── BookRepo.java
    │       │   └── ChangeLogRepo.java
    │       │
    │       ├── service
    │       │   ├── AuthorService.java
    │       │   ├── BookService.java
    │       │   ├── JournalListener.java
    │       │   └── NotificationListener.java
    │       │
    │       └── Lab2Application.java
    │
    └── resources
        ├── application.properties
        └── templates
```

## Функционал
Повторяет функционал из практической работы №3.
### Управление авторами
- Просмотр списка авторов  
- Добавление нового автора  
- Редактирование информации об авторе  
- Удаление автора  

---

### Управление книгами
- Просмотр списка книг  
- Добавление книги с указанием автора  
- Редактирование данных книги  
- Удаление книги  
- Фильтрация книг по жанру  

---

### Журналирование изменений
Каждое изменение данных (добавление, обновление, удаление сущностей `Author` и `Book`)
приводит к отправке JMS-сообщения в очередь.

Полученные сообщения обрабатываются асинхронно и сохраняются в таблицу `change_log`,
содержащую следующую информацию:
- тип операции (`INSERT`, `UPDATE`, `DELETE`)
- имя сущности
- идентификатор сущности
- описание изменения
- дату и время события

Логирование производится в таблицу. Ниже то, что творилось при разработке и проверке функционала (для проверки логирования, которое не работало, было создано несколько одинаковых книг Достоевского с разными isnb, которые уже при починке логирования были удалены, что можно увидеть ниже).

<img width="2476" height="1006" alt="image" src="https://github.com/user-attachments/assets/ac384482-116c-43ab-b258-ff7e517b4145" />

### Исправление от 17.01.2026:
Ранее два слушателя (JournalListener и NotificationListener) висели на одной очереди (Queue), что приводило к недетерминированному поведению.
Теперь используется JMS Topic, на который подписаны оба слушателя. Это гарантирует, что каждое сообщение обрабатывается всеми подписчиками, и логирование и уведомления работают корректно (по крайней мере, теперь все логи корректно отправляются в таблицу).
На фото ниже записи в таблицу.

<img width="1602" height="817" alt="image" src="https://github.com/user-attachments/assets/de6357c8-80e5-46c5-9f8b-2d68ae05144d" />

---

### Система уведомлений
Для выбранных типов событий (например, удаление книги) реализована система
email-уведомлений.  
При выполнении заданного условия обработчик JMS отправляет уведомление
на указанный адрес электронной почты.

Тестовая отправка производится с помощью MailHog.

<img width="2858" height="621" alt="image" src="https://github.com/user-attachments/assets/890cef5f-aa8b-4a2c-909c-ba8c45206361" />
<img width="2864" height="614" alt="image" src="https://github.com/user-attachments/assets/a4ac36d9-0697-4af5-bf46-8b686bb17a24" />


---

## Структура базы данных

### Таблица `author`
- `id` — идентификатор автора (PRIMARY KEY)
- `first_name` — имя
- `last_name` — фамилия
- `birth_year` — год рождения
- `country` — страна

---

### Таблица `book`
- `id` — идентификатор книги (PRIMARY KEY)
- `title` — название
- `isbn` — ISBN
- `genre` — жанр
- `publish_year` — год публикации
- `pages` — количество страниц
- `author_id` — внешний ключ на таблицу `author`

---

### Таблица `change_log`
- `id` — идентификатор записи (PRIMARY KEY)
- `event_time` — дата и время события
- `operation_type` — тип операции
- `entity_name` — имя сущности
- `entity_id` — идентификатор сущности
- `details` — описание изменений

---

## Используемые технологии
- Java  
- Spring Boot  
- Spring MVC  
- Spring Data JPA  
- Java Message Service (JMS)  
- Apache ActiveMQ  
- Hibernate  
- Maven  
- HTML / CSS  

---

## Запуск приложения

1. Установить и запустить СУБД (PostgreSQL или H2)
2. Создать базу данных
3. Настроить параметры подключения в `application.properties`
4. Установить и запустить **Apache ActiveMQ**
   - Брокер: `tcp://localhost:61616`
   - Web Console: `http://localhost:8161`
5. Собрать проект с помощью Maven
6. Запустить приложение
7. Открыть веб-интерфейс в браузере
8. Выполнить операции добавления, редактирования и удаления данных
9. Убедиться, что изменения фиксируются в таблице `change_log`
   и обрабатываются асинхронно через JMS
